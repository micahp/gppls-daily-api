<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="imageContainer" class="flex flex-wrap justify-center p-8"></div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';

        function sortImagesList(arr) {
            return arr.sort((a, b) => {
                let imageNumberA = a.split('.')[0];
                let imageNumberB = b.split('.')[0];
                return imageNumberA - imageNumberB;
            });
        }

        function sortStringsByCharacters(arr) {
            return arr.sort((a, b) => {
                for (let i = 0; i < Math.min(a.length, b.length); i++) {
                    if (a.charCodeAt(i) !== b.charCodeAt(i)) {
                        return a.charCodeAt(i) - b.charCodeAt(i);
                    }
                }
                // If all characters so far are equal, the shorter string should come first
                return a.length - b.length;
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const imageContainer = document.getElementById('imageContainer');
            let songs = [];
            let songList = [];
            let imageFiles = [];

            // Fetch image files
            const imageResponse = await fetch(`${API_BASE_URL}/image-files`);
            imageFiles = await imageResponse.json();
            
            // Sort the imageFiles
            imageFiles = sortImagesList(imageFiles);
            
            console.log('Sorted imageFiles: ', imageFiles);

            // Fetch audio files
            const audioResponse = await fetch(`${API_BASE_URL}/audio-files`);
            songList = await audioResponse.json();
            
            // Sort the songList
            songList = sortStringsByCharacters(songList);
            
            console.log('Sorted songList: ', songList);

            // Function to find corresponding song
            function findSong(imageNumber) {
                console.log('findSong: ', imageNumber);
                const searchPattern = `gppls daily ${imageNumber}`;
                const mp3Song = songList.find(s => {
                    const match = s.match(/gppls daily (\d+)/i);
                    return match && parseInt(match[1]) === parseInt(imageNumber) && s.endsWith('.mp3');
                });
                if (mp3Song) return mp3Song;
                const wavSong = songList.find(s => {
                    const match = s.match(/gppls daily (\d+)/i);
                    return match && match[1] === imageNumber && s.endsWith('.wav');
                });
                return wavSong || null;
            }

            // Display images and song names
            imageFiles.forEach(file => {
                if (/^\d+$/.test(file.split('.')[0])) {
                    const imageNumber = file.split('.')[0];
                    console.log('imageNumber: ', imageNumber);
                    const song = findSong(imageNumber);
                    const songName = song ? song.replace(/\.(mp3|wav)$/, '') : 'Unknown Song';

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'm-8 text-center';
                    imageDiv.innerHTML = `
                        <img src="${API_BASE_URL}/images/${file}" alt="${songName}" 
                             class="w-[250px] h-[250px] object-cover cursor-pointer hover:opacity-80 transition-opacity" 
                             onclick="playSong('${imageNumber}')">
                        <p class="mt-2 text-lg">${songName}</p>
                    `;
                    imageContainer.appendChild(imageDiv);
                }
            });

            // Function to play song (to be implemented)
            window.playSong = function(imageNumber) {
                console.log('playSong: ', imageNumber);
                const song = findSong(imageNumber);
                if (song) {
                    const songIndex = songList.indexOf(song);
                    console.log('Playing song:', song, 'at index:', songIndex);
                    // Call playSong function from script.js
                    window.parent.playSong(songIndex);
                } else {
                    console.log("No song associated with this image");
                }
            }
        });
    </script>
</body>
</html>